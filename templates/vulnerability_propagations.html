<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Vulnerabilities by Repository Count</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <!-- Tabulator CSS (match main.html theme/version) -->
  <link href="https://unpkg.com/tabulator-tables@6.3.1/dist/css/tabulator.min.css" rel="stylesheet" />
  <link href="https://unpkg.com/tabulator-tables@6.3.1/dist/css/tabulator_simple.min.css" rel="stylesheet" />
  <style>
    /* clickable cursor for tabulator headers to match main.html */
    .tabulator .tabulator-col { cursor: pointer; }
    /* make all tabulator tables larger */
    .tabulator { font-size: 1rem; }
    .tabulator .tabulator-header .tabulator-col { font-size: 1rem; padding: 10px 12px; }
    .tabulator .tabulator-cell { padding: 10px 12px; }
    .tabulator .tabulator-footer { font-size: 0.95rem; }
    /* Make all Tabulator tables 80% of the viewport width and center them */
    .tabulator { width: min(80vw, 100%); margin-left: auto; margin-right: auto; }
  </style>
</head>
<body>
  {% include 'navbar.html' %}
  <div class="container-fluid my-5">
    <h1 class="mb-4">Vulnerabilities by Repository Count</h1>
    
    <button id="expand-btn" class="btn btn-primary mb-3">Show All Vulnerabilities</button>
    <div id="vuln-table"></div>
  </div>
  <!-- Top Repositories by Vulnerable Libraries -->
  <div class="container-fluid my-5">
    <h2 class="mb-4">Top Repositories by Vulnerable Libraries</h2>
    <div id="repo-vuln-table"></div>
  </div>
  <!-- Top Vulnerable Libraries (Aggregated) -->
  <div class="container-fluid my-5">
    <div class="alert alert-info py-2 small">
      <strong>How to read these tables</strong>
      <ul class="mb-0">
        <li><strong>Repositories Affected</strong>: Summed count if CVEs in all repositories <code>repo_count</code>.</li>
        <li><strong>Organizations Affected</strong>: number of unique organizations that have at least one affected repository in the group.</li>
        <li><strong>CVEs / Vulnerability Entries</strong>: number of distinct advisories (e.g., GHSA/CVE <code>vulnerability_id</code>) associated with the group.</li>
        <li>“Top 20” sections show only the first 20 rows; use “View full list” to see all.</li>
      </ul>
    </div>
    <h2 class="mb-4">Top Vulnerable Libraries (Aggregated)</h2>

    <div class="card shadow-sm mb-4">
      <div class="card-header bg-danger text-white">
        Top 20 by Repositories Affected
      </div>
      <div class="card-body">
        <div id="lib-top-repos"></div>
      </div>
    </div>

    <div class="card shadow-sm">
      <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
        <span>Top 20 by Organizations Affected</span>
        <button class="btn btn-sm btn-outline-dark" data-toggle="modal" data-target="#orgsFullModal">View full list</button>
      </div>
      <div class="card-body">
        <div id="lib-top-orgs"></div>
      </div>
    </div>
  </div>

  <!-- Modal: Full list by Organizations Affected -->
  <div class="modal fade" id="orgsFullModal" tabindex="-1" role="dialog" aria-labelledby="orgsFullModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="orgsFullModalLabel">All Vulnerable Libraries by Organizations Affected</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div id="lib-top-orgs-full"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Top Vulnerable Libraries by Version (Aggregated) -->
  <div class="container-fluid my-5">
    <h2 class="mb-4">Top Vulnerable Libraries by Version</h2>
    <p class="text-muted small mt-n3 mb-3">Grouped by <em>Library + Installed Version</em>. Counts above apply per version (e.g., “Vulnerability Entries” are advisories tied to that exact version).</p>

    <div class="card shadow-sm mb-4">
      <div class="card-header bg-danger text-white">
        Top 20 by Repositories Affected (Library + Version)
      </div>
      <div class="card-body">
        <div id="libver-top-repos"></div>
      </div>
    </div>

    <div class="card shadow-sm">
      <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
        <span>Top 20 by Organizations Affected (Library + Version)</span>
        <button class="btn btn-sm btn-outline-dark" data-toggle="modal" data-target="#libVerOrgsFullModal">View full list</button>
      </div>
      <div class="card-body">
        <div id="libver-top-orgs"></div>
      </div>
    </div>
  </div>

  <!-- Modal: Full list by Organizations Affected (Library + Version) -->
  <div class="modal fade" id="libVerOrgsFullModal" tabindex="-1" role="dialog" aria-labelledby="libVerOrgsFullModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="libVerOrgsFullModalLabel">All Vulnerable Libraries by Organizations Affected (Library + Version)</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div id="libver-top-orgs-full"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabulator JS (match main.html version) -->
  <script src="https://unpkg.com/tabulator-tables@6.3.1/dist/js/tabulator.min.js"></script>
  <!-- Bootstrap 4 JS deps for modal -->
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <!-- Inject vulnerability data -->
  <script id="vuln-data" type="application/json">
    {{ vuln_repos|tojson|safe }}
  </script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const allData = JSON.parse(document.getElementById('vuln-data').textContent);
      let showAll = false;
      const linkPrefix = "{{ url_for('vuln_repos', vuln_id='') }}";
      const orgLinkPrefix = "{{ url_for('vuln_orgs', vuln_id='') }}";
      // Initialize Tabulator with top 15
      const table = new Tabulator('#vuln-table', {
        data: allData.slice(0,15),
        layout: 'fitColumns',
        rowHeight: 44,
        columns: [
          { title: 'Vulnerability ID', field: 'vulnerability_id', formatter: function(cell) {
              const vid = cell.getValue();
              return `<a href="${linkPrefix}${vid}">${vid}</a>`;
            }
          },
          { title: 'Severity', field: 'severity' }, 
          { title: 'Package', field: 'package_name' },
          { title: 'Description', field: 'description' },
          { title: 'Version', field: 'installed_version' },
          { title: 'Repositories Affected', field: 'repo_count', hozAlign:'right' },
          { title: 'Orgs Affected', field: 'organizations', hozAlign:'right', formatter:function(cell){
              const orgs = cell.getValue() || [];
              const count = orgs.length;
              if(!count) return '0';
              const vid = cell.getRow().getData().vulnerability_id;
              const href = `${orgLinkPrefix}${encodeURIComponent(vid)}`;
              return `<a href="${href}" class="badge badge-info">${count}</a>`;
            }
          },
        ],
      });
      // Expand/collapse button
      document.getElementById('expand-btn').addEventListener('click', function() {
        if (!showAll) {
          table.replaceData(allData);
          this.textContent = 'Show Top 15 Only';
        } else {
          table.replaceData(allData.slice(0,15));
          this.textContent = 'Show All Vulnerabilities';
        }
        showAll = !showAll;
      });

      // Helper: extract repository names from a row if available, for de-duplication
      function normalizeRepoNames(row){
        const names = [];
        const candidates = [row && row.repositories, row && row.repos, row && row.repo_list, row && row.repository_list, row && row.repository_names];
        candidates.forEach(c => {
          if (!c) return;
          if (Array.isArray(c)) {
            c.forEach(it => {
              if (!it) return;
              if (typeof it === 'string') {
                it.split(',').forEach(s => { const v = s && s.trim(); if (v) names.push(v); });
              } else if (typeof it === 'object') {
                const v = it.full_name || it.repository || it.repo || it.name;
                if (v) names.push(String(v).trim());
              }
            });
          } else if (typeof c === 'string') {
            c.split(',').forEach(s => { const v = s && s.trim(); if (v) names.push(v); });
          }
        });
        if (!names.length && row) {
          const single = row.full_name || (row.organization && row.repository && `${row.organization}/${row.repository}`) || row.repository;
          if (single) names.push(String(single).trim());
        }
        return names.filter(Boolean);
      }

      // ---- Aggregate by Library (ignore versions) ----
      function aggregateLibraries(rows){
        const map = new Map();
        (rows||[]).forEach(r=>{
          const lib = (r.package_name || 'Unknown').trim();
          const repoCount = Number(r.repo_count)||0;
          const orgs = Array.isArray(r.organizations) ? r.organizations : [];
          let entry = map.get(lib);
          if(!entry){
            entry = { library: lib, repoSet: new Set(), repos_sum: 0, orgSet: new Set(), vulnerabilities: 0 };
            map.set(lib, entry);
          }
          // de-duplicated repos if names are available; otherwise fall back to sum
          const repoNames = normalizeRepoNames(r);
          repoNames.forEach(name => entry.repoSet.add(name));
          entry.repos_sum += repoCount;
          orgs.forEach(o=> entry.orgSet.add(o));
          entry.vulnerabilities += 1; // number of vuln entries tied to this library
        });
        return Array.from(map.values()).map(e=>({
          library: e.library,
          repos_affected: e.repoSet.size || e.repos_sum,
          orgs_affected: e.orgSet.size,
          vulnerabilities: e.vulnerabilities,
        }));
      }

      const libAgg = aggregateLibraries(allData);
      const topByRepos = [...libAgg].sort((a,b)=> b.repos_affected - a.repos_affected).slice(0,20);
      const topByOrgs  = [...libAgg].sort((a,b)=> b.orgs_affected  - a.orgs_affected ).slice(0,20);

      const libCols = [
        { title:'Library', field:'library' },
        { title:'Repositories Affected', field:'repos_affected', hozAlign:'right' },
        { title:'Organizations Affected', field:'orgs_affected', hozAlign:'right' },
        { title:'CVEs', field:'vulnerabilities', hozAlign:'right' },
      ];

      new Tabulator('#lib-top-repos', {
        data: topByRepos,
        columns: libCols,
        layout: 'fitColumns',
        rowHeight: 44,
      });

      new Tabulator('#lib-top-orgs', {
        data: topByOrgs,
        columns: libCols,
        layout: 'fitColumns',
        rowHeight: 44,
      });

      // Full list (all rows) sorted by Organizations Affected -> show in modal on demand
      const allByOrgs = [...libAgg].sort((a,b)=> b.orgs_affected - a.orgs_affected);
      function initOrgsFullTable(){
        if (window.orgsFullTable) return;
        window.orgsFullTable = new Tabulator('#lib-top-orgs-full', {
          data: allByOrgs,
          columns: libCols,
          layout: 'fitColumns',
          height: '80vh',
          rowHeight: 44,
        });
      }
      if (window.jQuery && typeof jQuery.fn.modal === 'function') {
        jQuery('#orgsFullModal').on('shown.bs.modal', initOrgsFullTable);
      } else {
        // Fallback: initialize shortly after click
        document.querySelectorAll('[data-target="#orgsFullModal"]').forEach(btn=>{
          btn.addEventListener('click', ()=> setTimeout(initOrgsFullTable, 200));
        });
      }

      // ---- Aggregate by Library + Version ----
      function aggregateLibrariesByVersion(rows){
        const map = new Map();
        (rows||[]).forEach(r=>{
          const lib = (r.package_name || 'Unknown').trim();
          const ver = (r.installed_version || 'Unknown').toString().trim();
          const key = `${lib}::${ver}`;
          const repoCount = Number(r.repo_count)||0;
          const orgs = Array.isArray(r.organizations) ? r.organizations : [];
          let entry = map.get(key);
          if(!entry){
            entry = { library: lib, version: ver, repoSet: new Set(), repos_sum: 0, orgSet: new Set(), vulnerabilities: 0 };
            map.set(key, entry);
          }
          const repoNames = normalizeRepoNames(r);
          repoNames.forEach(name => entry.repoSet.add(name));
          entry.repos_sum += repoCount;
          orgs.forEach(o=> entry.orgSet.add(o));
          entry.vulnerabilities += 1;
        });
        return Array.from(map.values()).map(e=>({
          library: e.library,
          version: e.version,
          repos_affected: e.repoSet.size || e.repos_sum,
          orgs_affected: e.orgSet.size,
          vulnerabilities: e.vulnerabilities,
        }));
      }

      const libVerAgg = aggregateLibrariesByVersion(allData);
      const topVerByRepos = [...libVerAgg].sort((a,b)=> b.repos_affected - a.repos_affected).slice(0,20);
      const topVerByOrgs  = [...libVerAgg].sort((a,b)=> b.orgs_affected  - a.orgs_affected ).slice(0,20);

      const libVerCols = [
        { title:'Library', field:'library' },
        { title:'Version', field:'version' },
        { title:'Repositories Affected', field:'repos_affected', hozAlign:'right' },
        { title:'Organizations Affected', field:'orgs_affected', hozAlign:'right' },
        { title:'Vulnerability Entries', field:'vulnerabilities', hozAlign:'right' },
      ];

      new Tabulator('#libver-top-repos', {
        data: topVerByRepos,
        columns: libVerCols,
        layout: 'fitColumns',
        rowHeight: 44,
      });

      new Tabulator('#libver-top-orgs', {
        data: topVerByOrgs,
        columns: libVerCols,
        layout: 'fitColumns',
        rowHeight: 44,
      });

      // Full list for Library + Version by Organizations Affected -> show in modal on demand
      const allVerByOrgs = [...libVerAgg].sort((a,b)=> b.orgs_affected - a.orgs_affected);
      function initVerOrgsFullTable(){
        if (window.libVerOrgsFullTable) return;
        window.libVerOrgsFullTable = new Tabulator('#libver-top-orgs-full', {
          data: allVerByOrgs,
          columns: libVerCols,
          layout: 'fitColumns',
          height: '80vh',
          rowHeight: 44,
        });
      }
      if (window.jQuery && typeof jQuery.fn.modal === 'function') {
        jQuery('#libVerOrgsFullModal').on('shown.bs.modal', initVerOrgsFullTable);
      } else {
        document.querySelectorAll('[data-target="#libVerOrgsFullModal"]').forEach(btn=>{
          btn.addEventListener('click', ()=> setTimeout(initVerOrgsFullTable, 200));
        });
      }
    });
  </script>
  <!-- Inject top repo vulnerability data -->
  <script id="repo-data" type="application/json">
    {{ repo_vuln|tojson|safe }}
  </script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Parse repository vulnerability data
      const repoData = JSON.parse(document.getElementById('repo-data').textContent);
      // Initialize Tabulator for repositories with all columns
      new Tabulator('#repo-vuln-table', {
        data: repoData,
        layout: 'fitColumns',
        autoColumns: true,
        rowHeight: 44,
      });
    });
  </script>
</body>
</html>
